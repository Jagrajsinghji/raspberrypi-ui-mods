#!/bin/sh

CONF_DIR=${HOME}/.config/
BACKUP_DIR=${HOME}/oldconffiles/.config/
UPDATE_LIST=${CONF_DIR}/.update-list

backup_and_copy_new()
{
    DIRP=$(dirname "$2")/
    mkdir -p "${CONF_DIR}${DIRP}"
    mkdir -p "${BACKUP_DIR}${DIRP}"
    mv -f "${CONF_DIR}${2}" "${BACKUP_DIR}${2}"
    cp "$1" "${CONF_DIR}${2}"
}

if [ -e "$UPDATE_LIST" ] ; then
    if zenity --question --width 400 --text "There are new desktop configuration files available.\n\nIf you have made changes to your desktop settings, some of these may be overwritten by the new configuration.\n\nPress 'Yes' to update your configuration or 'No' to keep your current configuration."; then
        sort -u "$UPDATE_LIST" | while read line
        do
            case $line in
                *pcmanfm/LXDE-pi/pcmanfm.conf)
                    backup_and_copy_new /etc/xdg/pcmanfm/LXDE-pi/pcmanfm.conf pcmanfm/LXDE-pi/pcmanfm.conf
                ;;
                *pcmanfm/LXDE-pi/desktop-items-0.conf)
                    backup_and_copy_new /etc/xdg/pcmanfm/LXDE-pi/desktop-items-0.conf pcmanfm/LXDE-pi/desktop-items-0.conf
                ;;
                *openbox/lxde-pi-rc.xml)
                    backup_and_copy_new /etc/xdg/openbox/lxde-pi-rc.xml openbox/lxde-pi-rc.xml
                ;;
                *lxsession/LXDE-pi/desktop.conf)
                    backup_and_copy_new /etc/xdg/lxsession/LXDE-pi/desktop.conf lxsession/LXDE-pi/desktop.conf
                ;;
                *lxsession/LXDE-pi/autostart)
                    backup_and_copy_new /etc/xdg/lxsession/LXDE-pi/autostart lxsession/LXDE-pi/autostart
                ;;
                *lxsession/LXDE-pi/autokey.sh)
                    backup_and_copy_new /etc/xdg/lxsession/LXDE-pi/autokey.sh lxsession/LXDE-pi/autokey.sh
                ;;
                *lxpanel/launchtaskbar.cfg)
                    backup_and_copy_new /etc/xdg/lxpanel/launchtaskbar.cfg lxpanel/launchtaskbar.cfg
                ;;
                *lxpanel/LXDE-pi/config)
                    backup_and_copy_new /etc/xdg/lxpanel/profile/LXDE-pi/config lxpanel/LXDE-pi/config
                ;;
                *lxpanel/LXDE-pi/panels/panel)
                    backup_and_copy_new /etc/xdg/lxpanel/profile/LXDE-pi/panels/panel lxpanel/LXDE-pi/panels/panel
                ;;
                *qt5ct/qt5ct.conf)
                    backup_and_copy_new /usr/share/raspi-ui-overrides/qt5ct.conf qt5ct/qt5ct.conf
                ;;
            esac
        done
        openbox --reconfigure
        pcmanfm --reconfigure
        lxpanelctl restart
    fi
    rm "$UPDATE_LIST"
fi


